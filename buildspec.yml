version: 0.2

env:
  variables:
    # -----------------------------------------------------------------
    # This should be your AWS region (eu-north-1)
    AWS_REGION: "eu-north-1"
    # -----------------------------------------------------------------
    EKS_CLUSTER_NAME: "msa-cluster"
    # UPDATED: Removed "config-server" from this list
    SERVICES: "api-gateway attendance-frontend attendance-service course-service eureka-server reporting-service user-service"
    IMAGE_TAG: "latest"

phases:
  install:
    commands:
      - echo "Installing kubectl"
      - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
      - chmod +x ./kubectl
      - mv ./kubectl /usr/local/bin/kubectl

  pre_build:
    commands:
      - echo "Getting AWS Account ID"
      - export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
      - if [ -z "$AWS_ACCOUNT_ID" ]; then echo "AWS_ACCOUNT_ID is not set. Exiting."; exit 1; fi
      - echo "Logging in to Amazon ECR"
      - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com
      - export ECR_REPO_PREFIX="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

  build:
    commands:
      - echo "Building and pushing all 7 microservices..."
      - |
        set -e
        for service in $SERVICES; do
          echo "Building $service..."
          cd $service
          docker build -t $ECR_REPO_PREFIX/$service:$IMAGE_TAG .
          echo "Pushing $service to ECR..."
          docker push $ECR_REPO_PREFIX/$service:$IMAGE_TAG
          cd ..
        done
      - echo "All images built and pushed."

  post_build:
    commands:
      - echo "Updating kubeconfig for EKS cluster $EKS_CLUSTER_NAME"
      - aws eks update-kubeconfig --name $EKS_CLUSTER_NAME --region $AWS_REGION
      - echo "Preparing Kubernetes manifests"
      - echo "Returning to source directory..."
      - cd $CODEBUILD_SRC_DIR
      - cd k8s-manifests
      - echo "Replacing image placeholders..."
      - |
        set -e
        for service in $SERVICES; do
          placeholder_name=$(echo "$service" | tr '[:lower:]' '[:upper:]' | tr '-' '_')
          sed -i "s|IMAGE_PLACEHOLDER_${placeholder_name}|$ECR_REPO_PREFIX/$service:$IMAGE_TAG|g" *.yaml
        done
      - echo "Applying Kubernetes manifests..."
      - kubectl apply -f 00-namespace.yaml
      - kubectl apply -f 02-eureka-server.yaml

      # UPDATED: Commented out config-server deployment
      # - kubectl apply -f 03-config-server.yaml

      - kubectl apply -f 04-microservices.yaml
      - kubectl apply -f 05-api-gateway.yaml
      - kubectl apply -f 06-frontend.yaml
      - echo "Deployment complete."

artifacts:
  files: []